#!/usr/bin/env bash

set -euo pipefail

source ~/.config/gyazo/env

upload() {
  local file=$1
  xdg-open $(curl -s \
    -F access_token=${ACCESS_TOKEN} \
    -F imagedata=@$file \
    -F created_at=$(date +%s) \
    -F collection_id=${COLLECTION_ID} \
    https://upload.gyazo.com/api/upload \
    | jq -r .permalink_url)
}

capture() {
  local filename=~/Pictures/$(date +%Y-%m-%dT%H-%M-%S).png

  local wid=$(xdotool selectwindow)
  if test ! -z $wid ; then
    maim -f png -i $wid $filename
    upload $filename
  fi
}

screenshot() {
  local filename=~/Pictures/$(date +%Y-%m-%dT%H-%M-%S).png
  maim -f png $filename
  upload $filename
}

main() {
  case "${1:-}" in
    capture)
        capture
      ;;
    screenshot)
      screenshot
      ;;
  esac
}

main $@
